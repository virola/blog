<!DOCTYPE HTML><html><head><meta charset="utf-8"><title>ruby on rails使用HTTP认证token实现用户登录验证和会话保持 | Virola&#39;s Blog</title><meta name="author" content="Virola"><meta name="description" content="Virola&#39;s Blog"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta property="og:title" content="ruby on rails使用HTTP认证token实现用户登录验证和会话保持"><meta property="og:site_name" content="Virola&#39;s Blog"><meta property="og:image" content="undefined"><meta name="baidu-site-verification" content="e5EBCWO83G"><meta name="google-site-verification" content="P1Pa9bT3k2Wsn9uKE5in0gjGysZ4xBYGPYkCsxtkpyI"><link href="/favicon.ico" rel="icon"><link rel="alternate" href="/atom.xml" title="Virola&#39;s Blog" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Virola&#39;s Blog</a></h1><h2><a href="/">For love &amp; freedom. 爱与自由。</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="http://www.virola-eko.com">Home</a></li><li><a href="/">Blog</a></li><li><a href="/archives">Archives</a></li><li><a href="/about-me">About Me</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2018-5-10 23:48:51"><a href="/2018/ruby-on-rails-user-token.html">2018-05-10</a></time><h1 class="title">ruby on rails使用HTTP认证token实现用户登录验证和会话保持</h1></header><div class="entry"><h2 id="增加认证-Authentication"><a href="#增加认证-Authentication" class="headerlink" title="增加认证(Authentication)"></a>增加认证(Authentication)</h2><p>认证的过程是这样的: 用户把用户名和密码通过 HTTP POST 请求发送到我们的 API (在这里我们使用 sessions 端点来处理这个请求), 如果用户名和密码匹配，我们会把 <code>token</code> 发送给用户。 这个 token 就是用来证明用户身份的凭证。然后在以后的每个请求中，我们都通过这个 token 来查找用户，如果没有找到用户则返回 401 错误。</p><a id="more"></a><h3 id="给-Member-模型增加-authentication-token-属性"><a href="#给-Member-模型增加-authentication-token-属性" class="headerlink" title="给 Member 模型增加 authentication_token 属性"></a>给 Member 模型增加 authentication_token 属性</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rails g migration add_authentication_token_to_members</span></span><br></pre></td></tr></table></figure><p>db/migrate/20180510152021_add_authentication_token_to_members.rb :</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddAuthenticationTokenToMembers</span> &lt; ActiveRecord::Migration</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></span><br><span class="line">    add_column <span class="symbol">:members</span>, <span class="symbol">:authentication_token</span>, <span class="symbol">:string</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>$ rake db:migrate</p><h3 id="生成-authentication-token"><a href="#生成-authentication-token" class="headerlink" title="生成 authentication_token"></a>生成 authentication_token</h3><p>app/models/member.rb,<br></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Member</span> &lt; ActiveRecord::Base</span></span><br><span class="line"></span><br><span class="line">   before_create <span class="symbol">:generate_authentication_token</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">generate_authentication_token</span></span></span><br><span class="line">     loop <span class="keyword">do</span></span><br><span class="line">       <span class="keyword">self</span>.authentication_token = SecureRandom.base64(<span class="number">64</span>)</span><br><span class="line">       <span class="keyword">break</span> <span class="keyword">if</span> !Member.find_by(<span class="symbol">authentication_token:</span> authentication_token)</span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">reset_auth_token!</span></span></span><br><span class="line">     generate_authentication_token</span><br><span class="line">     save</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p></p><p>这里给 Member 模型增加了一个 <code>reset_auth_token!</code> 方法，这样做的理由主要有以下几点:</p><ul><li>需要有一个方法帮助用户重置 authentication token, 而不仅仅是在创建用户时生成 authenticeation token；</li><li>如果用户的 token 被泄漏了，我们可以通过 reset_auth_token! 方法方便地重置用户 token ；</li></ul><h3 id="sessions-endpoint"><a href="#sessions-endpoint" class="headerlink" title="sessions endpoint"></a>sessions endpoint</h3><p>生成 sessions 控制器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 我们不需要生成资源文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rails g controller api/v1/sessions --no-assets</span></span><br><span class="line"></span><br><span class="line">  create  app/controllers/api/v1/sessions_controller.rb</span><br><span class="line">  invoke  erb</span><br><span class="line">  create    app/views/api/v1/sessions</span><br><span class="line">  invoke  test_unit</span><br><span class="line">  create    test/controllers/api/v1/sessions_controller_test.rb</span><br><span class="line">  invoke  helper</span><br><span class="line">  create    app/helpers/api/v1/sessions_helper.rb</span><br><span class="line">  invoke    test_unit</span><br></pre></td></tr></table></figure><p>app/controllers/api/v1/sessions_controller.rb</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Api::V1::SessionsController</span> &lt; Api::V1::<span class="title">BaseController</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create</span></span></span><br><span class="line">    @member = Member.find_by(<span class="symbol">username:</span> create_params[<span class="symbol">:username</span>]).authenticate(create_params[<span class="symbol">:password</span>])</span><br><span class="line">    <span class="keyword">if</span> @member</span><br><span class="line">      <span class="keyword">self</span>.current_member = @member</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      api_error(<span class="symbol">status:</span> <span class="number">401</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create_params</span></span></span><br><span class="line">    params.<span class="keyword">require</span>(<span class="symbol">:member</span>).permit(<span class="symbol">:username</span>, <span class="symbol">:open_id</span>, <span class="symbol">:password</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>实现 api_error 和 current_member 方法</p><p>app/controllers/api/v1/base_controller.rb :</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Api::V1::BaseController</span> &lt; ApplicationController</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:current_member</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">api_error</span><span class="params">(opts = &#123;&#125;)</span></span></span><br><span class="line">    render <span class="symbol">nothing:</span> <span class="literal">true</span>, <span class="symbol">status:</span> opts[<span class="symbol">:status</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>现在还需要做一些额外工作:</p><ul><li>给 Member 模型增加密码验证，整理数据库，给数据库中已存在的测试用户增加相关字段;</li><li>实现 app/views/api/v1/sessions/create.json.jbuilder;</li><li>配置和 sessions 相关的路由;</li></ul><h3 id="给-Member-模型增加密码验证，整理数据库"><a href="#给-Member-模型增加密码验证，整理数据库" class="headerlink" title="给 Member 模型增加密码验证，整理数据库"></a>给 Member 模型增加密码验证，整理数据库</h3><p>在 Gemfile 里将 gem ‘bcrypt’ 这一行的注释取消</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use ActiveModel has_secure_password</span></span><br><span class="line"><span class="string">gem</span> <span class="string">'bcrypt'</span><span class="string">,</span> <span class="string">'~&gt; 3.1.7'</span></span><br></pre></td></tr></table></figure><p>app/models/member.rb :</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Member</span> &lt; ActiveRecord::Base</span></span><br><span class="line">    has_secure_password</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>给 Member 模型增加 <code>password_digest</code> 属性:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rails g migration add_password_digest_to_members</span></span><br></pre></td></tr></table></figure><p>db/migrate/20180510153029_add_password_digest_to_members.rb :</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddPasswordDigestToMembers</span> &lt; ActiveRecord::Migration</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></span><br><span class="line">    add_column <span class="symbol">:members</span>, <span class="symbol">:password_digest</span>, <span class="symbol">:string</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>执行：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bundle install</span><br><span class="line">$ rake db:migrate</span><br></pre></td></tr></table></figure><p></p><p>整理之前的用户数据。给数据库中已存在的测试用户增加 password 和 authentication token，这个任务可以在 rails console 下完成。</p><p>首先启动 rails console ：</p><p>$ rails c</p><p>然后在 rails console 里执行：<br></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Member.all.each &#123;<span class="params">|member|</span></span><br><span class="line">  member.password = <span class="string">'123123'</span></span><br><span class="line">  member.reset_auth_token!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="实现-app-views-api-v1-sessions-create-json-jbuilder"><a href="#实现-app-views-api-v1-sessions-create-json-jbuilder" class="headerlink" title="实现 app/views/api/v1/sessions/create.json.jbuilder"></a>实现 app/views/api/v1/sessions/create.json.jbuilder</h3><p>app/views/api/v1/sessions/create.json.jbuilder :<br></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> @member</span><br><span class="line">  json.session <span class="keyword">do</span></span><br><span class="line">    json.(@member, <span class="symbol">:id</span>, <span class="symbol">:username</span>, <span class="symbol">:nickname</span>, <span class="symbol">:role</span>)</span><br><span class="line">    json.token @member.authentication_token</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p></p><h3 id="配置和-sessions-相关的路由"><a href="#配置和-sessions-相关的路由" class="headerlink" title="配置和 sessions 相关的路由"></a>配置和 sessions 相关的路由</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Rails.application.routes.draw <span class="keyword">do</span></span><br><span class="line">  namespace <span class="symbol">:api</span> <span class="keyword">do</span></span><br><span class="line">    namespace <span class="symbol">:v1</span> <span class="keyword">do</span></span><br><span class="line">       resources <span class="symbol">:sessions</span>, <span class="symbol">only:</span> [<span class="symbol">:create</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>现在做一个测试看是否能够顺利地拿到用户的 token, 我们使用下面的用户作为测试用户:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  username: &apos;222&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>浏览器console执行:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ajax request</span><br><span class="line">$.post(<span class="string">'/api/v1/sessions.json'</span>, <span class="string">'member[username]=222&amp;member[password]=123123'</span>);</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"session"</span>:&#123;<span class="attr">"id"</span>:<span class="number">2</span>,<span class="attr">"username"</span>:<span class="string">"222"</span>,<span class="attr">"nickname"</span>:<span class="string">"222333"</span>,<span class="attr">"role"</span>:<span class="string">"admin"</span>,<span class="attr">"token"</span>:<span class="string">"ji14ZeekYZCtJ0tShU88rgQuRsym/XEOnO+01SjWr94DXYzSlIoKzuBQUYmvnxrcHNGgNuqX+ey/1jKkgx0jrg=="</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>顺利地拿到了 token。我们再做一个验证失败的测试，使用一个错误的密码: fakepwd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -X POST -d &quot;member[username]=222&amp;member[password]=fakepwd&quot; http://localhost:3000/api/v1/sessions.json</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ajax request</span><br><span class="line">$.post(<span class="string">'/api/v1/sessions.json'</span>, <span class="string">'member[username]=222&amp;member[password]=fakepwd'</span>);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">X-XSS-Protection: 1; mode=block</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-Download-Options: noopen</span><br><span class="line">X-Permitted-Cross-Domain-Policies: none</span><br><span class="line">Referrer-Policy: strict-origin-when-cross-origin</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">X-Request-Id: 41934010-eb83-4216-82a6-4cf42ad8fc4e</span><br><span class="line">X-Runtime: 0.136374</span><br><span class="line">Vary: Origin</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">&#123;&#125;%</span><br></pre></td></tr></table></figure><p>此时服务器返回了 401 Unauthorized</p><h2 id="Authenticate-Member"><a href="#Authenticate-Member" class="headerlink" title="Authenticate Member"></a>Authenticate Member</h2><p>在前面的测试中，我们已经成功地拿到了用户的 token, 那么现在我们把 token 和 username 发给 API，看能否成功识别出用户。<br>首先在 <code>Api::V1::BaseController</code> 里实现 <code>authenticate_member!</code> 方法:</p><p>app/controllers/api/v1/base_controller.rb,<br></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Api::V1::BaseController</span> &lt; ApplicationController</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">authenticate_member!</span></span></span><br><span class="line">    token, options = ActionController::HttpAuthentication::Token.token_and_options(request)</span><br><span class="line"></span><br><span class="line">    member_username = options.blank?? <span class="literal">nil</span> : options[<span class="symbol">:username</span>]</span><br><span class="line">    member = member_username &amp;&amp; Member.find_by(<span class="symbol">username:</span> member_username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> member &amp;&amp; ActiveSupport::SecurityUtils.secure_compare(member.authentication_token, token)</span><br><span class="line">      <span class="keyword">self</span>.current_member = member</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> unauthenticated!</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">unauthenticated!</span></span></span><br><span class="line">    api_error(<span class="symbol">status:</span> <span class="number">401</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p></p><p><code>ActionController::HttpAuthentication::Token</code> 是 rails 自带的方法，可以参考 rails 文档 了解其详情。</p><p>这里通过 <code>member_username</code> 拿到 <code>member</code> ，然后通过 <code>ActiveSupport::SecurityUtils.secure_compare</code> 对 <code>member.authentication_token</code> 和从请求头里取到的 token 进行比较，如果匹配则认证成功，否则返回 <code>unauthenticated!</code> 。这里使用了 <code>secure_compare</code> 对字符串进行比较，是为了防止时序攻击(timing attack)</p><p>我们构造一个测试用例, 这个测试用例包括以下一些步骤:</p><ul><li>用户登录成功, 服务端返回其 username, token 等数据</li><li>用户请求 API 更新其 nickname, 用户发送的 token 合法, 更新成功</li><li>用户请求 API 更新其 nickname, 用户发送的 token 非法, 更新失败</li></ul><p>为了让用户能够更新其 nickname, 我们需要实现 member <code>update</code> API, 并且加入用户验证 <code>before_action</code></p><p>app/controllers/api/v1/members_controller.rb,<br></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Api::V1::MembersController</span> &lt; Api::V1::<span class="title">BaseController</span></span></span><br><span class="line"></span><br><span class="line">  before_action <span class="symbol">:authenticate_member!</span>, <span class="symbol">only:</span> [<span class="symbol">:update</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">update</span></span></span><br><span class="line">    @member = Member.find(params[<span class="symbol">:id</span>])</span><br><span class="line">    @member.update_attributes(update_params)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">update_params</span></span></span><br><span class="line">    params.<span class="keyword">require</span>(<span class="symbol">:member</span>).permit(<span class="symbol">:nickname</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p></p><p>app/views/api/v1/members/update.json.jbuilder,<br></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">json.member <span class="keyword">do</span></span><br><span class="line">  json.(@member, <span class="symbol">:id</span>, <span class="symbol">:username</span>, <span class="symbol">:nickname</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p></p><p>现在我们进行测试, 测试用户是:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  id: 2,</span><br><span class="line">  username: &apos;222&apos;,</span><br><span class="line">  nickname: &apos;222233&apos;,</span><br><span class="line">  authentication_token: &apos;ji14ZeekYZCtJ0tShU88rgQuRsym/XEOnO+01SjWr94DXYzSlIoKzuBQUYmvnxrcHNGgNuqX+ey/1jKkgx0jrg==&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i -X PUT -d &quot;member[nickname]=new-member&quot; \</span><br><span class="line">  --header &quot;Authorization: Token token=ji14ZeekYZCtJ0tShU88rgQuRsym/XEOnO+01SjWr94DXYzSlIoKzuBQUYmvnxrcHNGgNuqX+ey/1jKkgx0jrg==, \</span><br><span class="line">  username=222&quot; \</span><br><span class="line">  http://localhost:3000/api/v1/members/2</span><br><span class="line"></span><br><span class="line"># result</span><br><span class="line">&#123;&quot;member&quot;:&#123;&quot;id&quot;:2,&quot;username&quot;:&quot;222&quot;,&quot;nickname&quot;:&quot;hello2&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>我们看到 member nickname 已经成功更新。</p><p><strong>请注意: 你们自己测试时需要将 token 换为你们自己生成的 token。</strong></p><p>我们使用一个非法的 token 去请求 API, 看看会发生什么状况。</p><pre><code>$ curl -i -X PUT -d &quot;member[nickname]=new-member&quot; \
  --header &quot;Authorization: Token token=faketoken, \
  username=222&quot; \
  http://localhost:3000/api/v1/members/2

# result
HTTP/1.1 401 Unauthorized
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block
X-Content-Type-Options: nosniff
X-Download-Options: noopen
X-Permitted-Cross-Domain-Policies: none
Referrer-Policy: strict-origin-when-cross-origin
Content-Type: application/json; charset=utf-8
Cache-Control: no-cache
X-Request-Id: 5d6c11fd-9e05-439f-848a-259b24e183dd
X-Runtime: 0.164683
Vary: Origin
Transfer-Encoding: chunked
</code></pre><p>服务器返回 401 Unauthorized, 并且 member nickname 没有被更新。</p></div><footer><div class="categories"><a href="/categories/前端/">前端</a></div><div class="tags"><a href="/tags/ruby-on-rails/">ruby on rails</a></div><div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div><script>with(window._bd_share_config={common:{bdSnsKey:{},bdText:"",bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"0",bdSize:"32"},share:{}},document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)</script><div class="clearfix"></div></footer></div></article><section id="comment"></section></div></div><aside id="sidebar" class="alignright"><div class="search"><form action="//google.com/search" method="get" accept-charset="utf-8"><input type="search" name="q" results="0" placeholder="搜索"> <input type="hidden" name="q" value="site:www.zhuyuwei.cn"></form></div><div class="widget tag"><h3 class="title">分类</h3><ul class="entry"><li><a href="/categories/photo/">photo</a><small>1</small></li><li><a href="/categories/tips/">tips</a><small>1</small></li><li><a href="/categories/whatever/">whatever</a><small>6</small></li><li><a href="/categories/前端/">前端</a><small>7</small></li></ul></div><div class="widget tag"><h3 class="title">标签</h3><ul class="entry"><li><a href="/tags/angular/">angular</a><small>1</small></li><li><a href="/tags/linux/">linux</a><small>1</small></li><li><a href="/tags/mina/">mina</a><small>1</small></li><li><a href="/tags/mysql/">mysql</a><small>2</small></li><li><a href="/tags/node/">node</a><small>1</small></li><li><a href="/tags/phantomjs/">phantomjs</a><small>1</small></li><li><a href="/tags/photo/">photo</a><small>1</small></li><li><a href="/tags/ruby-on-rails/">ruby on rails</a><small>2</small></li><li><a href="/tags/shell/">shell</a><small>1</small></li><li><a href="/tags/travel/">travel</a><small>1</small></li><li><a href="/tags/vue/">vue</a><small>3</small></li><li><a href="/tags/whatever/">whatever</a><small>3</small></li><li><a href="/tags/发发牢骚/">发发牢骚</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><p class="links"><a href="/">Home</a> <a href="https://github.com/virola/blog">Github</a> <a href="http://virola-eko.com">VirolaEko</a></p><div class="alignleft">&copy; 2018 Virola</div><div class="clearfix"></div></footer><script src="//s1.bdstatic.com/r/www/cache/static/jquery/jquery-1.10.2.min_f2fb5194.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen"><script src="/fancybox/jquery.fancybox.pack.js"></script><script>jQuery(".fancybox").fancybox()</script><a id="return-top" href="#"><i class="icon-arrow-up"></i></a><script>$(function(){var n=$("#return-top").hide();$(window).on("scroll",function(){200<$(window).scrollTop()?n.fadeIn():n.fadeOut()}),n.on("click",function(){return $("html,body").animate({scrollTop:0}),!1})})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b1e207e5306b2425b9d1d7a374e10afd";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>