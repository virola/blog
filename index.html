<!DOCTYPE HTML><html><head><meta charset="utf-8"><title>Virola&#39;s Blog</title><meta name="author" content="Virola"><meta name="description" content="Virola&#39;s Blog"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta property="og:site_name" content="Virola&#39;s Blog"><meta property="og:image" content=""><meta name="baidu-site-verification" content="e5EBCWO83G"><meta name="google-site-verification" content="P1Pa9bT3k2Wsn9uKE5in0gjGysZ4xBYGPYkCsxtkpyI"><link href="/favicon.ico" rel="icon"><link rel="alternate" href="/atom.xml" title="Virola&#39;s Blog" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><meta name="generator" content="Hexo 5.4.0"></head><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Virola&#39;s Blog</a></h1><h2><a href="/">For love &amp; freedom. 爱与自由。</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a target="_blank" rel="noopener" href="http://www.virola-eko.com">Home</a></li><li><a href="/">Blog</a></li><li><a href="/archives">Archives</a></li><li><a href="/about-me">About Me</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="3/28/2022, 7:24:38 AM"><a href="/2022/travis-on-vps.html">2022-03-28</a></time><h1 class="title"><a href="/2022/travis-on-vps.html">travis-ci 持续集成构建产物部署到远程主机的记录</a></h1></header><div class="entry"><p>一转眼都2022年了，这工具一直在改造，之前我维护的hexo博客自动部署到主机的配置文件现在又不能用了。<br>没办法，工具在升级，我也得继续好好学习啊。<br>今天就来研究研究现在最新的 travis-ci (<a target="_blank" rel="noopener" href="https://app.travis-ci.com/">https://app.travis-ci.com</a>) 是怎么配置实现将构建的产物部署到指定的远程主机上。</p><p>首先是要保证 travis 的持续集成构建步骤，开启 travis 的自动构建很简单，只要在项目中加入 <code>.travis.yml</code> 这个文件即可。基本配置参考：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">12</span></span><br><span class="line"><span class="attr">cache:</span> <span class="string">npm</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-cli</span> <span class="string">gulp-cli</span> <span class="string">-g</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">pages</span></span><br><span class="line">  <span class="attr">skip_cleanup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># $GH_TOKEN 这个参数需要在 github 的 personal access token 中获取，</span></span><br><span class="line">  <span class="comment"># 然后在 travis 的 options 中配置好</span></span><br><span class="line">  <span class="attr">github_token:</span> <span class="string">$GH_TOKEN</span></span><br><span class="line">  <span class="attr">keep_history:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">local_dir:</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">on:</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以上配置文件 <code>.travis.yml</code> 会将生成的文件自动提交到 <code>gh_pages</code> 分支。</p><p>其中比较重要的deploy参数就是 <code>provider: pages</code>，详细的文档可以看<a target="_blank" rel="noopener" href="https://docs.travis-ci.com/user/deployment/pages/">这里</a>（没有中文版还得自个翻译）。<br>hexo 默认生成的静态文件是在 <code>public</code> 目录下的，所以这里 <code>local_dir</code> 有指定上传目录。</p></div><footer><div class="alignleft"><a href="/2022/travis-on-vps.html#more" class="more-link">READ MORE</a></div><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="12/9/2021, 9:32:54 AM"><a href="/2021/trojan-docker.html">2021-12-09</a></time><h1 class="title"><a href="/2021/trojan-docker.html">通过 docker-compose 安装 trojan ，修改指定端口</a></h1></header><div class="entry"><p><code>jrohy/trojan</code> 这个trojan镜像启动web时默认端口绑定在80上，占用了宿主机的端口，适合专职机场的vps，安装其推荐的安装方式安装比较好。</p><p>所以暂时不考虑使用端口转发。</p><p><code>docker-compose.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2.3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mariadb:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mariadb:10.2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/home/mariadb:/var/lib/mysql:Z</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=mycustompassword</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">MYSQL_ROOT_HOST=%</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=trojan</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">trojan:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">jrohy/trojan</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">commond:</span> [ <span class="string">&quot;init&quot;</span> ]</span><br></pre></td></tr></table></figure></div><footer><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="7/21/2021, 7:40:24 AM"><a href="/2021/serverless.html">2021-07-21</a></time><h1 class="title"><a href="/2021/serverless.html">腾讯云 + serverless 快速部署全栈项目（vue + express + postgresql）</a></h1></header><div class="entry"><p>初步试用了一下 serverless 一键生成项目框架和部署到腾讯云，果然和官方宣传的一样，过程非常丝滑。<br>基本操作按照官方文档的指导来就可以正常完成一个框架的部署。</p><h3 id="操作场景"><a href="#操作场景" class="headerlink" title="操作场景"></a>操作场景</h3><p>该模板可以快速部署一个基于 Vue + Express + PostgreSQL 的全栈 Serverless 应用。主要包含以下组件：</p><ul><li>Serverless RESTful API：通过<strong>云函数</strong>和 <strong>API 网关</strong>构建的 Express 框架实现 RESTful API。</li><li>Serverless 静态网站：前端通过托管 Vue.js 静态页面到 <strong>COS 对象存储</strong>中。</li><li>PostgreSQL Serverless：通过创建 <strong>PostgreSQL DB</strong> 为全栈网站提供数据库服务。</li><li>VPC：通过创建 <strong>VPC</strong> 和 <strong>子网</strong>，提供 SCF 云函数和数据库的网络打通和使用。</li></ul><blockquote><p>说明：<br>本项目云函数因 VPC，导致无法直接访问外网，如需访问外网请参考 云函数网络配置。</p></blockquote><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/583/38202">https://cloud.tencent.com/document/product/583/38202</a></p><h2 id="初始化应用"><a href="#初始化应用" class="headerlink" title="初始化应用"></a>初始化应用</h2><p>在空目录下，执行初始化命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 交互式 serverless 初始化命令</span></span><br><span class="line">$ serverless</span><br></pre></td></tr></table></figure><p>接下来按照交互提示，完成项目初始化，选择 <code>fullstack</code> 组件模版，并等待依赖安装结束：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Serverless: 当前未检测到 Serverless 项目，是否希望新建一个项目？ Yes</span><br><span class="line">Serverless: 请选择您希望创建的 Serverless 应用 fullstack</span><br><span class="line"></span><br><span class="line">  eggjs-starter - 快速部署一个Egg.js 基础应用</span><br><span class="line">  express-starter - 快速部署一个 Express.js 基础应用</span><br><span class="line">  flask-starter - 快速部署一个 Flask 基础应用</span><br><span class="line">❯ fullstack - 快速部署一个 Full Stack 应用, vuejs + express + postgres</span><br><span class="line">  koa-starter - 快速部署一个 Koa.js 基础应用</span><br><span class="line">  laravel-starter - 快速部署一个 Laravel 基础应用</span><br><span class="line">  nextjs-starter - 快速部署一个 nextjs 应用</span><br><span class="line"></span><br><span class="line">Serverless: 请输入项目名称 fullstack</span><br><span class="line">Serverless: 正在安装 fullstack 应用...</span><br><span class="line"></span><br><span class="line">- 项目 &quot;fullstack&quot; 已在当前目录成功创建</span><br><span class="line">- 执行 &quot;cd fullstack &amp;&amp; serverless deploy&quot; 部署应用</span><br><span class="line"></span><br><span class="line">fullstack › 创建成功</span><br></pre></td></tr></table></figure></div><footer><div class="alignleft"><a href="/2021/serverless.html#more" class="more-link">READ MORE</a></div><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="7/7/2021, 9:10:14 AM"><a href="/2021/jenkins-jmeter.html">2021-07-07</a></time><h1 class="title"><a href="/2021/jenkins-jmeter.html">在jenkins pipeline 项目 + jmeter 自动化测试 + HTML Publisher 生成测试报告</a></h1></header><div class="entry"><p>最近在调研jmeter自动化测试这个topic，简单学习了一下jmeter的各种用法和语法，用jmeter写一套测试计划倒是挺简单的。<br>不过我认为，ui工具写出来的用例，如果不能git维护+持续集成，那就谈不上自动化测试。<br>所以就有了 jenkins + jmeter + 生成报告的这套工具的构建。</p><p>总结一下我的操作步骤，以及解决的一些坑（如生成的HTML报告没有样式等问题）</p><h2 id="构建结果展示"><a href="#构建结果展示" class="headerlink" title="构建结果展示"></a>构建结果展示</h2><p>项目构建状态：</p><p><img src="/2021/jenkins-jmeter/project.png" alt="project"></p><p>HTML生成报告：</p><p><img src="/2021/jenkins-jmeter/html.png" alt="html"></p></div><footer><div class="alignleft"><a href="/2021/jenkins-jmeter.html#more" class="more-link">READ MORE</a></div><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="6/21/2021, 7:33:59 AM"><a href="/2021/github-sync-gitee.html">2021-06-21</a></time><h1 class="title"><a href="/2021/github-sync-gitee.html">使用Github Actions自动同步仓库代码至gitee</a></h1></header><div class="entry"><p>本文主要研究通过 github actions 自动同步仓库代码至 gitee，顺便了解一下github actions的基础用法。</p><h2 id="1-Github和Gitee添加公钥"><a href="#1-Github和Gitee添加公钥" class="headerlink" title="1. Github和Gitee添加公钥"></a>1. Github和Gitee添加公钥</h2><h3 id="通过终端生成公钥"><a href="#通过终端生成公钥" class="headerlink" title="通过终端生成公钥"></a>通过终端生成公钥</h3><p>在终端中输入： <code>ssh-keygen</code> ，不需要输入任何信息，直接回车，默认生成公钥文件如图：</p><p><img src="/2021/github-sync-gitee/public_key.png" alt="public key"></p><p>根据提示的文件路径，查看公钥内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 根据路径修改，如： cat /c/Users/Administrator/.ssh/id_rsa.pub</span><br><span class="line">cat [xxx.pub]</span><br></pre></td></tr></table></figure><h3 id="添加公钥信息"><a href="#添加公钥信息" class="headerlink" title="添加公钥信息"></a>添加公钥信息</h3><p>将输入的公钥内容复制下来，分别添加至 <code>github</code> 和 <code>gitee</code> 账户设置中。</p><ul><li>github: <a target="_blank" rel="noopener" href="https://github.com/settings/keys">https://github.com/settings/keys</a></li><li>gitee: <a target="_blank" rel="noopener" href="https://gitee.com/profile/sshkeys">https://gitee.com/profile/sshkeys</a></li></ul><h3 id="检查公钥是否成功添加"><a href="#检查公钥是否成功添加" class="headerlink" title="检查公钥是否成功添加"></a>检查公钥是否成功添加</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br><span class="line">ssh -T git@gitee.com</span><br></pre></td></tr></table></figure><p>返回成功认证的信息，则说明成功添加公钥。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># like this.</span><br><span class="line">Hi! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure></div><footer><div class="alignleft"><a href="/2021/github-sync-gitee.html#more" class="more-link">READ MORE</a></div><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="6/4/2021, 7:09:12 AM"><a href="/2021/centos-yum-nginx.html">2021-06-04</a></time><h1 class="title"><a href="/2021/centos-yum-nginx.html">Centos用yum安装的nginx相关配置</a></h1></header><div class="entry"><p>使用 <code>yum install nginx</code> 安装的 nginx 服务器，配置文件路径：</p><ul><li><code>html</code> 目录默认路径： <code>/usr/share/nginx/html</code></li><li>默认 <code>nginx.conf</code> 路径： <code>/etc/nginx/nginx.conf</code></li><li>vhost 配置目录：<code>/etc/nginx/conf.d</code></li></ul><p>现在开始普及 docker 之后，基本上 nginx 就是专门用来做转发配置了。</p></div><footer><div class="alignleft"><a href="/2021/centos-yum-nginx.html#more" class="more-link">READ MORE</a></div><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="6/4/2021, 1:59:36 AM"><a href="/2021/docker-portainer.html">2021-06-04</a></time><h1 class="title"><a href="/2021/docker-portainer.html">Linux 安装 docker 可视化管理工具 Portainer</a></h1></header><div class="entry"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Portainer是一个可视化的容器镜像的图形管理工具，利用Portainer可以轻松构建，管理和维护Docker环境。 而且完全免费，基于容器化的安装方式，方便高效部署。</p><p>官网：<a target="_blank" rel="noopener" href="https://www.portainer.io/">https://www.portainer.io/</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>官网提供的 docker 安装方式： <a target="_blank" rel="noopener" href="https://documentation.portainer.io/v2.0/deploy/ceinstalldocker/">https://documentation.portainer.io/v2.0/deploy/ceinstalldocker/</a></p><p>1 创建一个docker数据目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create portainer_data</span><br></pre></td></tr></table></figure><p>2 启动服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8000:8000 -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</span><br></pre></td></tr></table></figure><p>3 初始化管理账户</p><p>用浏览器访问： http://[ip]:9000</p><p>设置管理员用户名密码。</p><p>4 选择管理方式</p><p>点击 <code>Docker</code> -&gt; <code>Connect</code> 确定。</p><p>以上，配置完成。</p><p>点击左侧菜单栏的 <code>Host</code> 可以查看主机信息。</p></div><footer><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="6/3/2021, 9:29:22 AM"><a href="/2021/vps-docker-shadowsocks.html">2021-06-03</a></time><h1 class="title"><a href="/2021/vps-docker-shadowsocks.html">Centos系统的 VPS 初始环境整理（yum, docker, node, vpn, ss 等等）</a></h1></header><div class="entry"><p>搞了一台新VPS上手，一堆软件又不记得怎么装了。记录一下各种软件部署的流程。</p><h2 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h2><h3 id="升级yum"><a href="#升级yum" class="headerlink" title="升级yum"></a>升级yum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum update</span><br><span class="line">yum makecache  #生成仓库缓存</span><br></pre></td></tr></table></figure><h3 id="基础工具"><a href="#基础工具" class="headerlink" title="基础工具"></a>基础工具</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y git python3</span><br><span class="line">sudo yum install -y gcc gcc-c++</span><br></pre></td></tr></table></figure><p>nodejs - 推荐用下面的 <code>nvm</code> 安装替代:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 下载node 版本参考&lt;https://nodejs.org/en/download/&gt;</span><br><span class="line">wget https://nodejs.org/dist/v12.18.3/node-v12.18.3-linux-x64.tar.xz</span><br><span class="line">tar -xvf node-v12.18.3-linux-x64.tar.gz</span><br><span class="line">cd node-v12.18.3-linux-x64</span><br><span class="line">./configure</span><br><span class="line"># 编译</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"># 查看node版本</span><br><span class="line">node -v</span><br></pre></td></tr></table></figure><p>nvm - node版本管理工具:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash</span><br></pre></td></tr></table></figure><p>完成后，在 <code>.bash_profile</code> 文件中加入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export NVM_DIR=&quot;$([ -z &quot;$&#123;XDG_CONFIG_HOME-&#125;&quot; ] &amp;&amp; printf %s &quot;$&#123;HOME&#125;/.nvm&quot; || printf %s &quot;$&#123;XDG_CONFIG_HOME&#125;/nvm&quot;)&quot;</span><br><span class="line">[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; \. &quot;$NVM_DIR/nvm.sh&quot; # This loads nvm</span><br></pre></td></tr></table></figure><p>执行 <code>source .bash_profile</code> 后，安装 node 的命令就很简单了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm install stable</span><br></pre></td></tr></table></figure></div><footer><div class="alignleft"><a href="/2021/vps-docker-shadowsocks.html#more" class="more-link">READ MORE</a></div><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="8/13/2020, 8:04:50 AM"><a href="/2020/gulp-compress.html">2020-08-13</a></time><h1 class="title"><a href="/2020/gulp-compress.html">用gulp实现全站HTML、CSS、JS和图片压缩</a></h1></header><div class="entry"><p>最近被安利了一款一键更新 npm package 的小工具，叫 <code>npm-check-updates</code> ，装完只需要在目录下运行 <code>ncu -u</code>，然后就会自动把 package.json 中的包版本更新到最新版本号，然后再一键 <code>npm install</code> 就完成了依赖升级。</p><p>本来这个博客 <code>hexo</code> 也是好多年前起的，看到最近 hexo 发布了 5.0 大版本，冲动之下马上一键更新，结果发现自己之前定制的 gulp 压缩脚本也用不了，跑去官网一看，原来 gulp 更新的新版本的语法已经变了。</p><p>于是只好花了2个小时左右学习新版本的语法，重写了 hexo 的全站压缩脚本 <code>gulpfile.js</code>。</p><p>先上官网：</p><ul><li><a target="_blank" rel="noopener" href="https://gulpjs.com/">https://gulpjs.com/</a></li></ul><p>再来个中文网快速入门：</p><ul><li><a target="_blank" rel="noopener" href="https://www.gulpjs.com.cn/">https://www.gulpjs.com.cn/</a></li></ul></div><footer><div class="alignleft"><a href="/2020/gulp-compress.html#more" class="more-link">READ MORE</a></div><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="8/12/2020, 8:28:59 AM"><a href="/2020/nodejs-upload-base64-img.html">2020-08-12</a></time><h1 class="title"><a href="/2020/nodejs-upload-base64-img.html">nodejs将base64编码的图片上传至指定服务器</a></h1></header><div class="entry"><p>最近做项目的时候遇到了一个小细节问题，对接第三方云平台接口拿到了一个图片的 base64 编码，微信小程序中需要使用这个图片，并且将图片上传至java后端服务器上。<br>后端提供了图片上传接口，但只支持 <code>FormData</code> 文件流，不支持 base64 直接传，前端需要考虑的就是如何把 base64 编码变成图片。</p><p>这个其实 web 端已经有成熟的方案了，将 base64 转换成二进制图片 <code>Blob</code>，再组装 FormData 对象即可完成。</p><p>贴一段示例代码，应该很容易看懂：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> base64String = <span class="string">&#x27;/*base64图片串*/&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里对base64串进行操作，去掉url头，并转换为byte</span></span><br><span class="line"><span class="keyword">var</span> bytes = <span class="variable language_">window</span>.<span class="title function_">atob</span>(base64String.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>)[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理异常，将ASCII码小于0的转换为大于0</span></span><br><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(bytes.<span class="property">length</span>);</span><br><span class="line"><span class="keyword">var</span> ia = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(ab);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.<span class="property">length</span>; i++) &#123;</span><br><span class="line">  ia[i] = bytes.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Blob对象</span></span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([ab], &#123;<span class="attr">type</span>: <span class="string">&#x27;image/jpeg&#x27;</span>&#125;); <span class="comment">//type为图片的格式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// FormData对象</span></span><br><span class="line"><span class="keyword">var</span> fd = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// FormData对象接受三个参数，第三个参数为文件名，通常我们只传前两个参数，第三个参数不传则使用默认文件名。</span></span><br><span class="line"><span class="comment">// 这里使用的Blob对象，所以需要一个文件名，用时间戳代替。</span></span><br><span class="line">fd.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, blob, <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="string">&#x27;.jpg&#x27;</span>);</span><br></pre></td></tr></table></figure><p>然而这一切到了<strong>微信小程序</strong>上，开始变得困难了 =。=</p><p>微信小程序里没有 <code>atob</code> ，也不支持 <code>Blob</code> 对象，这种转换不允许放在微信小程序上前端执行。这时候我只好退而求其次，让 nodejs 作为中间件去完成这个小任务。</p></div><footer><div class="alignleft"><a href="/2020/nodejs-upload-base64-img.html#more" class="more-link">READ MORE</a></div><div class="clearfix"></div></footer></div></article><nav id="pagination"><a href="/page/2/" class="alignright next">下一页</a><div class="clearfix"></div></nav></div></div><aside id="sidebar" class="alignright"><div class="search"><form action="//google.com/search" method="get" accept-charset="utf-8"><input type="search" name="q" results="0" placeholder="搜索"> <input type="hidden" name="q" value="site:www.zhuyuwei.cn"></form></div><div class="widget tag"><h3 class="title">分类</h3><ul class="entry"><li><a href="/categories/linux/">linux</a><small>3</small></li><li><a href="/categories/photo/">photo</a><small>1</small></li><li><a href="/categories/tips/">tips</a><small>1</small></li><li><a href="/categories/vps/">vps</a><small>2</small></li><li><a href="/categories/whatever/">whatever</a><small>9</small></li><li><a href="/categories/前端/">前端</a><small>13</small></li><li><a href="/categories/后端/">后端</a><small>2</small></li></ul></div><div class="widget tag"><h3 class="title">标签</h3><ul class="entry"><li><a href="/tags/VPS/">VPS</a><small>1</small></li><li><a href="/tags/angular/">angular</a><small>1</small></li><li><a href="/tags/docker/">docker</a><small>1</small></li><li><a href="/tags/git/">git</a><small>1</small></li><li><a href="/tags/github/">github</a><small>1</small></li><li><a href="/tags/gulp/">gulp</a><small>1</small></li><li><a href="/tags/java/">java</a><small>1</small></li><li><a href="/tags/jenkins/">jenkins</a><small>1</small></li><li><a href="/tags/linux/">linux</a><small>4</small></li><li><a href="/tags/mac/">mac</a><small>1</small></li><li><a href="/tags/mina/">mina</a><small>1</small></li><li><a href="/tags/mysql/">mysql</a><small>2</small></li><li><a href="/tags/nestjs/">nestjs</a><small>1</small></li><li><a href="/tags/nodejs/">nodejs</a><small>6</small></li><li><a href="/tags/phantomjs/">phantomjs</a><small>1</small></li><li><a href="/tags/photo/">photo</a><small>1</small></li><li><a href="/tags/ruby-on-rails/">ruby on rails</a><small>2</small></li><li><a href="/tags/serverless/">serverless</a><small>1</small></li><li><a href="/tags/shell/">shell</a><small>1</small></li><li><a href="/tags/travel/">travel</a><small>1</small></li><li><a href="/tags/travis/">travis</a><small>1</small></li><li><a href="/tags/vps/">vps</a><small>2</small></li><li><a href="/tags/vue/">vue</a><small>4</small></li><li><a href="/tags/web/">web</a><small>1</small></li><li><a href="/tags/whatever/">whatever</a><small>4</small></li><li><a href="/tags/发发牢骚/">发发牢骚</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><p class="links"><a href="/">Home</a> <a target="_blank" rel="noopener" href="https://github.com/virola/blog">Github</a> <a target="_blank" rel="noopener" href="http://virola-eko.com">VirolaEko</a></p><div class="alignleft">&copy; 2022 Virola</div><div class="clearfix"></div></footer><script src="//s1.bdstatic.com/r/www/cache/static/jquery/jquery-1.10.2.min_f2fb5194.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen"><script src="/fancybox/jquery.fancybox.pack.js"></script><script>jQuery(".fancybox").fancybox()</script><a id="return-top" href="#"><i class="icon-arrow-up"></i></a><script>$(function(){var n=$("#return-top").hide();$(window).on("scroll",function(){200<$(window).scrollTop()?n.fadeIn():n.fadeOut()}),n.on("click",function(){return $("html,body").animate({scrollTop:0}),!1})})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b1e207e5306b2425b9d1d7a374e10afd";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>